// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTH
// ==========================================

model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  name                   String?
  googleId               String?   @unique
  passwordHash           String?
  avatarUrl              String?

  // Subscription
  subscriptionTier       String    @default("free") // free, starter, pro, lifetime
  razorpayCustomerId     String?   @unique
  razorpaySubscriptionId String?   @unique
  subscriptionStatus     String?   @default("inactive") // active, inactive, cancelled, past_due
  subscriptionEndDate    DateTime?

  // Relations
  businesses             Business[]
  audits                 Audit[]
  payments               Payment[]

  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@map("users")
}

// ==========================================
// BUSINESS
// ==========================================

model Business {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  gbpLocationId     String   @unique
  name              String
  address           String?
  phone             String?
  category          String?
  websiteUrl        String?

  // OAuth tokens (encrypted)
  accessToken       String?
  refreshToken      String?
  tokenExpiresAt    DateTime?

  // Relations
  posts             Post[]
  reviews           Review[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@map("businesses")
}

// ==========================================
// POSTS
// ==========================================

model Post {
  id                String    @id @default(cuid())
  businessId        String
  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  type              String    // UPDATE, OFFER, EVENT, PRODUCT
  content           String    @db.Text
  imageUrl          String?
  callToActionType  String?   // LEARN_MORE, BOOK, ORDER, SHOP, SIGN_UP, CALL
  callToActionUrl   String?

  scheduledAt       DateTime
  publishedAt       DateTime?
  gbpPostId         String?   // Google's post ID after publishing
  status            String    @default("scheduled") // scheduled, publishing, published, failed
  failReason        String?
  retryCount        Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([businessId])
  @@index([status, scheduledAt])
  @@map("posts")
}

// ==========================================
// REVIEWS
// ==========================================

model Review {
  id                String    @id @default(cuid())
  businessId        String
  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  gbpReviewId       String    @unique // Google's review ID
  reviewerName      String
  reviewerPhotoUrl  String?
  rating            Int       // 1-5
  comment           String?   @db.Text
  reviewDate        DateTime

  // Response
  aiGeneratedReply  String?   @db.Text
  postedReply       String?   @db.Text
  repliedAt         DateTime?
  replyStatus       String    @default("pending") // pending, ai_generated, posted

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([businessId])
  @@index([replyStatus])
  @@map("reviews")
}

// ==========================================
// AUDITS
// ==========================================

model Audit {
  id                String   @id @default(cuid())
  userId            String?
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  businessName      String
  email             String?
  overallScore      Int      // 0-100
  profileComplete   Int      // 0-35
  contentActivity   Int      // 0-35
  engagement        Int      // 0-30
  issues            Json     // Array of {category, severity, message, recommendation}
  recommendations   Json?    // Array of strings

  createdAt         DateTime @default(now())

  @@index([userId])
  @@map("audits")
}

// ==========================================
// PAYMENTS
// ==========================================

model Payment {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  razorpayOrderId       String?  @unique
  razorpayPaymentId     String?  @unique
  razorpaySubscriptionId String?
  razorpaySignature     String?

  amount                Int      // Amount in paise
  currency              String   @default("INR")
  status                String   @default("created") // created, captured, failed, refunded
  planType              String   // starter, pro, lifetime
  paymentMethod         String?  // upi, card, netbanking, wallet

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@map("payments")
}
